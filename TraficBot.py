import classifier as classifier
import cv2

token = '5910930270:AAGEAH26lE-w8OCvtGN6aiLBVbqVKjyiMok'

dct_1 = {'0': '1_1',
 '1': '1_11_1',
 '10': '1_18',
 '100': '4_5_5',
 '101': '4_5_6',
 '102': '4_8_1',
 '103': '4_8_2',
 '104': '4_8_3',
 '105': '4_8_4',
 '106': '4_8_5',
 '107': '4_8_6',
 '108': '5_1',
 '109': '5_11_1',
 '11': '1_19',
 '110': '5_12_1',
 '111': '5_13_1',
 '112': '5_13_2',
 '113': '5_14',
 '114': '5_14_1',
 '115': '5_14_2',
 '116': '5_14_3',
 '117': '5_15_2+1',
 '118': '5_15_2+2',
 '119': '5_15_2+3',
 '12': '1_2',
 '120': '5_15_2+5',
 '121': '5_15_3',
 '122': '5_15_5',
 '123': '5_16',
 '124': '5_17',
 '125': '5_18',
 '126': '5_19',
 '127': '5_2',
 '128': '5_20',
 '129': '5_21',
 '13': '1_20_1',
 '130': '5_22',
 '131': '5_23_2',
 '132': '5_24_2',
 '133': '5_29',
 '134': '5_3',
 '135': '5_31+10',
 '136': '5_31+20',
 '137': '5_31+30',
 '138': '5_31+40',
 '139': '5_31+5',
 '14': '1_20_2',
 '140': '5_31+50',
 '141': '5_32',
 '142': '5_33',
 '143': '5_4',
 '144': '5_5',
 '145': '5_6',
 '146': '5_7_1',
 '147': '5_7_2',
 '148': '5_8',
 '149': '5_9',
 '15': '1_20_3',
 '150': '6_15_1',
 '151': '6_15_2',
 '152': '6_15_3',
 '153': '6_16',
 '154': '6_2+30',
 '155': '6_2+40',
 '156': '6_2+50',
 '157': '6_2+60',
 '158': '6_2+70',
 '159': '6_2+80',
 '16': '1_21',
 '160': '6_3_1',
 '161': '6_4',
 '162': '6_6',
 '163': '6_7',
 '164': '6_8_1',
 '165': '6_8_2',
 '166': '6_8_3',
 '167': '7_1',
 '168': '7_11',
 '169': '7_12',
 '17': '1_22',
 '170': '7_13',
 '171': '7_14',
 '172': '7_18',
 '173': '7_2',
 '174': '7_3',
 '175': '7_4',
 '176': '7_5',
 '177': '7_6',
 '178': '7_7',
 '179': '7_9',
 '18': '1_23',
 '180': 'smoke',
 '181': 'unknown',
 '19': '1_24',
 '2': '1_11_2',
 '20': '1_25',
 '21': '1_26',
 '22': '1_27',
 '23': '1_28',
 '24': '1_29',
 '25': '1_30',
 '26': '1_31',
 '27': '1_33',
 '28': '1_5',
 '29': '1_6',
 '3': '1_12_1',
 '30': '1_7',
 '31': '1_8',
 '32': '2_1',
 '33': '2_2',
 '34': '2_3_1',
 '35': '2_3_L',
 '36': '2_3_R',
 '37': '2_4',
 '38': '2_5',
 '39': '2_6',
 '4': '1_12_2',
 '40': '2_7',
 '41': '3_1',
 '42': '3_10',
 '43': '3_15',
 '44': '3_16',
 '45': '3_17',
 '46': '3_18_1',
 '47': '3_18_2',
 '48': '3_19',
 '49': '3_2',
 '5': '1_13',
 '50': '3_20',
 '51': '3_21',
 '52': '3_24+10',
 '53': '3_24+110',
 '54': '3_24+20',
 '55': '3_24+30',
 '56': '3_24+40',
 '57': '3_24+5',
 '58': '3_24+50',
 '59': '3_24+60',
 '6': '1_14',
 '60': '3_24+70',
 '61': '3_24+80',
 '62': '3_24+90',
 '63': '3_25+20',
 '64': '3_25+30',
 '65': '3_25+40',
 '66': '3_25+5',
 '67': '3_25+50',
 '68': '3_25+60',
 '69': '3_25+70',
 '7': '1_15',
 '70': '3_26',
 '71': '3_27',
 '72': '3_28',
 '73': '3_29',
 '74': '3_30',
 '75': '3_31',
 '76': '3_32',
 '77': '3_33',
 '78': '3_5',
 '79': '3_6',
 '8': '1_16',
 '80': '3_7',
 '81': '3_8',
 '82': '3_9',
 '83': '4_1_1',
 '84': '4_1_2',
 '85': '4_1_2_1',
 '86': '4_1_3',
 '87': '4_1_3_1',
 '88': '4_1_4',
 '89': '4_1_5',
 '9': '1_17',
 '90': '4_1_6',
 '91': '4_2_1',
 '92': '4_2_2',
 '93': '4_2_3',
 '94': '4_3',
 '95': '4_4_1',
 '96': '4_4_2',
 '97': '4_5_1',
 '98': '4_5_2',
 '99': '4_5_4'}


dct_2 = {'1_1': 'Железнодорожный переезд со шлагбаумом',
 '1_10': 'Выезд на набережную',
 '1_11_1': 'Опасный поворот (правый)',
 '1_11_2': 'Опасный поворот (левый)',
 '1_12_1': 'Опасные повороты (с первым поворотом направо)',
 '1_12_2': 'Опасные повороты (с первым поворотом налево)',
 '1_13': 'Крутой спуск',
 '1_14': 'Крутой подъем',
 '1_15': 'Скользкая дорога',
 '1_16': 'Неровная дорога',
 '1_17': ' Искусственная неровность',
 '1_18': 'Выброс гравия',
 '1_19': 'Опасная обочина',
 '1_2': 'Железнодорожный переезд без шлагбаума',
 '1_20_1': ' Сужение дороги. ',
 '1_20_2': ' Сужение дороги ',
 '1_20_3': 'Сужение дороги',
 '1_21': 'Двустороннее движение',
 '1_22': 'Пешеходный переход',
 '1_23': ' Дети',
 '1_24': 'Пересечение с велосипедной дорожкой или велопешеходной дорожкой',
 '1_25': 'Дорожные работы',
 '1_26': 'Перегон скота',
 '1_27': 'Дикие животные',
 '1_28': 'Падение камней',
 '1_29': 'Боковой ветер',
 '1_30': 'Низколетящие самолеты',
 '1_31': 'Тоннель',
 '1_32': 'Затор',
 '1_33': 'Прочие опасности',
 '1_34_1': 'Направление поворота',
 '1_34_2': 'Направление поворота',
 '1_34_3': 'Направление поворота',
 '1_35': 'Участок перекрестка',
 '1_3_1': 'Однопутная железная дорога',
 '1_3_2': 'Многопутная железная дорога',
 '1_4': 'Приближение к железнодорожному переезду',
 '1_5': 'Пересечение с трамвайной линией',
 '1_6': 'Пересечение равнозначных дорог',
 '1_7': 'Пересечение с круговым движением',
 '1_8': 'Светофорное регулирование',
 '1_9': 'Разводной мост',
 '2_1': 'Главная дорога',
 '2_2': 'Конец главной дороги',
 '2_3_1': 'Пересечение со второстепенной дорогой',
 '2_3_2': '2.3.3, 2.3.4, 2.3.5, 2.3.6, 2.3.7.  Примыкание второстепенной дороги',
 '2_4': 'Уступите дорогу',
 '2_5': 'Движение без остановки запрещено',
 '2_6': 'Преимущество встречного движения',
 '2_7': 'Преимущество перед встречным движением',
 '3_1': 'Въезд запрещен',
 '3_10': 'Движение пешеходов запрещено',
 '3_11': 'Ограничение массы',
 '3_12': 'Ограничение массы, приходящейся на ось транспортного средства',
 '3_13': 'Ограничение высоты',
 '3_14': 'Ограничение ширины',
 '3_15': 'Ограничение длины',
 '3_16': 'Ограничение минимальной дистанции',
 '3_17_1': 'Таможня',
 '3_17_2': 'Опасность',
 '3_17_3': 'Контроль',
 '3_18_1': 'Поворот направо запрещен',
 '3_18_2': 'Поворот налево запрещен',
 '3_19': 'Разворот запрещен',
 '3_2': 'Движение запрещено',
 '3_20': 'Обгон запрещен',
 '3_21': 'Конец зоны запрещения обгона',
 '3_22': 'Обгон грузовым автомобилем запрещен',
 '3_23': 'Конец зоны запрещения обгона грузовым автомобилям',
 '3_24': 'Ограничение максимальной скорости',
 '3_25': 'Конец зоны ограничения максимальной скорости',
 '3_26': 'Подача звукового сигнала запрещена',
 '3_27': 'Остановка запрещена',
 '3_28': 'Стоянка запрещена',
 '3_29': 'Стоянка запрещена по нечетным числам месяца',
 '3_3': 'Движение механических транспортных средств запрещено',
 '3_30': 'Стоянка запрещена по четным числам месяца',
 '3_31': ' Конец зоны всех ограничений',
 '3_32': 'Движение транспортных средств с опасными грузами запрещено',
 '3_33': 'Движение транспортных средств с взрывчатыми и легковоспламеняющимися грузами запрещено',
 '3_4': 'Движение грузовых автомобилей запрещено',
 '3_5': 'Движение мотоциклов запрещено',
 '3_6': 'Движение тракторов запрещено',
 '3_7': ' Движение с прицепом запрещено',
 '3_8': 'Движение гужевых повозок запрещено',
 '3_9': 'Движение на велосипедах запрещено',
 '4_1_1': 'Движение прямо',
 '4_1_2': 'Движение направо',
 '4_1_3': 'Движение налево',
 '4_1_4': 'Движение прямо или направо',
 '4_1_5': 'Движение прямо или налево',
 '4_1_6': 'Движение направо или налево',
 '4_2_1': 'Объезд препятствия справа',
 '4_2_2': 'Объезд препятствия слева',
 '4_2_3': 'Объезд препятствия справа или слева',
 '4_3': 'Круговое движение',
 '4_4_1': ' Велосипедная дорожка',
 '4_4_2': 'Конец велосипедной дорожки',
 '4_5_1': 'Пешеходная дорожка',
 '4_5_2': 'Пешеходная и велосипедная дорожка с совмещенным движением (велопешеходная дорожка с совмещенным движением)',
 '4_5_3': 'Конец пешеходной и велосипедной дорожки с совмещенным движением (конец велопешеходной дорожки с совмещенным движением)',
 '4_5_4': 'Пешеходная и велосипедная дорожка с разделением движения',
 '4_5_5': 'Пешеходная и велосипедная дорожка с разделением движения',
 '4_5_6': 'Конец пешеходной и велосипедной дорожки с разделением движения (конец велопешеходной дорожки с разделением движения)',
 '4_5_7': 'Конец пешеходной и велосипедной дорожки с разделением движения (конец велопешеходной дорожки с разделением движения)',
 '4_6': 'Ограничение минимальной скорости',
 '4_7': 'Конец зоны ограничения минимальной скорости',
 '4_8_1': 'Направление движения транспортных средств с опасными грузами',
 '5_1': 'Автомагистраль',
 '5_10': 'Выезд на дорогу с реверсивным движением',
 '5_11_1': 'Дорога с полосой для маршрутных транспортных средств',
 '5_11_2': 'Дорога с полосой для велосипедистов',
 '5_12_1': 'Конец дороги с полосой для маршрутных транспортных средств',
 '5_12_2': 'Конец дороги с полосой для велосипедистов',
 '5_13_1': 'Выезд на дорогу с полосой для маршрутных транспортных средств',
 '5_13_2': 'Выезд на дорогу с полосой для маршрутных транспортных средств',
 '5_13_3': 'Выезд на дорогу с полосой для велосипедистов',
 '5_13_4': 'Выезд на дорогу с полосой для велосипедистов',
 '5_14': 'Полоса для велосипедистов 5.14.3. Конец полосы для велосипедистов',
 '5_14_1': 'Конец полосы для маршрутных транспортных средств',
 '5_15': 'Конец полосы',
 '5_15_1': ' Направления движения по полосам',
 '5_15_2': 'Направления движения по полосам ',
 '5_15_3': 'Начало полосы',
 '5_15_4': 'Начало полосы',
 '5_15_5': 'Конец полосы',
 '5_15_7': 'Направление движения по полосам',
 '5_15_8': 'Число полос',
 '5_16': 'Место остановки автобуса и (или) троллейбуса',
 '5_17': 'Место остановки трамвая',
 '5_18': 'Место стоянки легковых такси',
 '5_19': 'Пешеходный переход',
 '5_2': 'Конец автомагистрали',
 '5_20': 'Искусственная неровность',
 '5_21': 'Жилая зона',
 '5_22': 'Конец жилой зоны',
 '5_23_2': 'Начало населенного пункта',
 '5_24_1': 'Конец населенного пункта',
 '5_25': 'Начало населенного пункта',
 '5_26': 'Конец населенного пункта',
 '5_27': 'Зона с ограничением стоянки',
 '5_28': 'Конец зоны с ограничением стоянки',
 '5_29': 'Зона регулируемой стоянки',
 '5_3': 'Дорога для автомобилей',
 '5_30': 'Конец зоны регулируемой стоянки',
 '5_31': 'Зона с ограничением максимальной скорости',
 '5_32': 'Конец зоны с ограничением максимальной скорости',
 '5_33': 'Пешеходная зона',
 '5_33_1': 'Велосипедная зона',
 '5_34': 'Конец пешеходной зоны',
 '5_34_1': 'Конец велосипедной зоны',
 '5_35': 'Зона с ограничением экологического класса механических транспортных средств',
 '5_36': 'Зона с ограничением экологического класса грузовых автомобилей',
 '5_37': 'Конец зоны с ограничением экологического класса механических транспортных средств',
 '5_38': 'Конец зоны с ограничением экологического класса грузовых автомобилей',
 '5_4': 'Конец дороги для автомобилей',
 '5_5': 'Дорога с односторонним движением',
 '5_6': 'Конец дороги с односторонним движением',
 '5_7_1': 'Выезд на дорогу с односторонним движением.',
 '5_7_2': 'Выезд на дорогу с односторонним движением.',
 '5_8': ' Реверсивное движение',
 '5_9': 'Конец реверсивного движения',
 '6_1': 'Общие ограничения максимальной скорости',
 '6_10_1': 'Указатель направлений',
 '6_10_2': 'Указатель направлений',
 '6_11': 'Наименование объекта',
 '6_12': 'Указатель расстояний',
 '6_13': 'Километровый знак',
 '6_14_1': 'Номер маршрута',
 '6_14_2': 'Номер маршрута',
 '6_15_1': 'Направление движения для грузовых автомобилей',
 '6_15_2': 'Направление движения для грузовых автомобилей',
 '6_15_3': 'Направление движения для грузовых автомобилей',
 '6_16': 'Стоп-линия',
 '6_17': 'Схема объезда',
 '6_18_1': 'Направление объезда',
 '6_18_2': 'Направление объезда',
 '6_18_3': 'Направление объезда',
 '6_19_1': '6.19.2. Предварительный указатель перестроения на другую проезжую часть',
 '6_2': 'Рекомендуемая скорость',
 '6_20_1': '6.20.2. Аварийный выход',
 '6_21': 'Направление движения к аварийному выходу',
 '6_22': 'Фотовидеофиксация ',
 '6_3_1': ' Место для разворота',
 '6_3_2': 'Зона для разворота',
 '6_4': 'Парковка (парковочное место)',
 '6_5': 'Полоса аварийной остановки',
 '6_6': 'Подземный пешеходный переход',
 '6_7': 'Надземный пешеходный переход',
 '6_8_1': 'Тупик',
 '6_8_2': 'Тупик',
 '6_8_3': 'Тупик',
 '6_9_1': 'Предварительный указатель направлений',
 '6_9_2': 'Предварительный указатель направления',
 '6_9_3': 'Схема движения',
 '7_1': 'Пункт медицинской помощи',
 '7_10': ' Кемпинг',
 '7_11': 'Место отдыха',
 '7_12': ' Пост дорожно-патрульной службы',
 '7_13': 'Полиция',
 '7_14': 'Пункт транспортного контроля',
 '7_14_1': 'Пункт таможенного контроля',
 '7_15': 'Зона приема радиостанции, передающей информацию о дорожном движении',
 '7_16': 'Зона радиосвязи с аварийными службами',
 '7_17': 'Бассейн или пляж',
 '7_18': 'Туалет',
 '7_19': 'Телефон экстренной связи',
 '7_2': 'Больница',
 '7_20': 'Огнетушитель',
 '7_21': 'Автозаправочная станция с возможностью зарядки электромобилей',
 '7_3': 'Автозаправочная станция',
 '7_4': 'Техническое обслуживание автомобилей',
 '7_5': 'Мойка автомобилей',
 '7_6': 'Телефон',
 '7_7': 'Пункт питания',
 '7_8': 'Питьевая вода',
 '7_9': 'Гостиница или мотель',
 '8_10': 'Место для осмотра автомобилей',
 '8_11': 'Ограничение разрешенной максимальной массы',
 '8_12': 'Опасная обочина',
 '8_13': 'Направление главной дороги',
 '8_14': 'Полоса движения',
 '8_15': 'Слепые пешеходы',
 '8_16': 'Влажное покрытие',
 '8_17': 'Инвалиды',
 '8_18': 'Кроме инвалидов',
 '8_19': 'Класс опасного груза',
 '8_1_1': ' Расстояние до объекта',
 '8_1_2': 'Расстояние до объекта',
 '8_1_3': '8.1.4. Расстояние до объекта',
 '8_20_1': '8.20.2. Тип тележки транспортного средства',
 '8_21_1': '8.21.2., 8.21.3. Вид маршрутного транспортного средства',
 '8_22_1': '8.22.2., 8.22.3. Препятствие',
 '8_23': 'Фотовидеофиксация',
 '8_24': 'Работает эвакуатор',
 '8_25': 'Экологический класс транспортного средства',
 '8_2_1': '8.2.2., 8.2.3., 8.2.4., 8.2.5., 8.2.6. Зона действия',
 '8_3_1': '8.3.2., 8.3.3. Направление действия',
 '8_4_1': '8.4.2., 8.4.3., 8.4.3.1., 8.4.4., 8.4.5., 8.4.6., 8.4.7., 8.4.8. Вид транспортного средства',
 '8_4_9': '8.4.10., 8.4.11., 8.4.12., 8.4.13., 8.4.14., 8.4.15. Кроме вида транспортных средства',
 '8_5_1': 'Субботние, воскресные и праздничные дни',
 '8_5_2': 'Рабочие дни',
 '8_5_3': 'Дни недели',
 '8_5_4': 'Время действия',
 '8_5_5': '8.5.6., 8.5.7. Время действия',
 '8_6_1': '8.6.2., 8.6.3., 8.6.4., 8.6.5., 8.6.6., 8.6.7., 8.6.8., 8.6.9. Способ постановки транспортного средства на стоянку',
 '8_7': 'Стоянка с неработающим двигателем',
 '8_8': 'Платные услуги',
 '8_9': 'Ограничение продолжительности стоянки',
 '8_9_1': 'Стоянка только для владельцев парковочных разрешений',
 '8_9_2': 'Стоянка только транспортных средств дипломатического корпуса'}

import telebot
from PIL import Image
import numpy as np
from keras.models import load_model
import tempfile


def detect(image):
 gray = cv2.cvtColor(image, cv2.COLOR_BGR2GRAY)
 faces = classifier.detectMultiScale(gray, 1.3, 5)
 count = 0
 for (x, y, w, h) in faces:
  count = count + 1
  cv2.rectangle(image, (x, y), (x + w, y + h), (0, 255, 0), 5)
 return image, count


bot = telebot.TeleBot(token)


@bot.message_handler(content_types=["text"])
def start(message):
    if message.text=='/start':
        bot.send_message(message.chat.id, 'Здравствуйте, вы можете загрузить изображение дорожного знака для его классификации. Для корректного распознавания рекомендуется обрезать знак в четкую квадратную рамку. Вы также можете написать номер знака в виде "5_13_2" и получить его значение.')
    else:
        try:
            bot.send_message(message.chat.id, 'Это знак - ' + dct_2[message.text])
        except:
            bot.send_message(message.chat.id, 'Извините, этого знака нет в базе.')

@bot.message_handler(content_types=['photo'])
def handle_docs_photo(message):
    bot.reply_to(message, "Подождите немного.")
    file_info = bot.get_file(message.photo[len(message.photo) - 1].file_id)
    downloaded_file = bot.download_file(file_info.file_path)
    #f = tempfile.NamedTemporaryFile(delete=True).name + ".png"
    # bot.sendMessage(chat_id, "Retrieving %s" % path)
    src = 'file.png'
    with open(src, 'wb') as new_file:
        new_file.write(downloaded_file)


    img = Image.open('file.png')
    img = img.resize((40,40))
    img = np.array(img)
    img = np.expand_dims(img,0)

    model = load_model('D:/github/pythonProjects/RoadSign/TraficSignRecognition.h5')
    res = np.argmax(model(img))
    
    res = dct_1[str(res)]

    try:
        res = dct_2[str(res)]
        bot.send_message(message.chat.id, 'Предположительно это знак - ' + res)
    except:
        bot.send_message(message.chat.id, 'Предположительно это знак - ' + res)


if __name__ == '__main__':
     bot.infinity_polling()



